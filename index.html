<!DOCTYPE html>
<html lang='en' class='notranslate' translate='no'>
  <head>
      <meta name='google' content='notranslate' />
      <meta charset='UTF-8'>

      <link rel="icon" href="img/favicon-16x16.ico" type="image/x-icon" sizes="16x16">
      <link rel="icon" href="img/favicon-32x32.ico" type="image/x-icon" sizes="32x32">
      <link rel="icon" href="img/favicon-48x48.ico" type="image/x-icon" sizes="48x48">

      <meta name='description' content='An Offline Text-to-Speech Browser Tool'>
      <meta name='keywords' content='OCR,Tesseract,SpeechSynthesis API,Text-to-Speech'>
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <meta name='viewport' content='width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0' />
      <meta http-equiv='X-UA-Compatible' content='IE=Edge,chrome=1' />  
      <meta http-equiv='Content-Language' content='en' />
      <title>Text-To-Speech | Browser Tool</title>
      <meta name='msapplication-TileColor' content='#ffffff' />
      <meta name='theme-color' content='#ffffff' />
      <meta name='apple-mobile-web-app-status-bar-style' content='black-translucent' />
      <meta name='apple-mobile-web-app-capable' content='yes' />
      <meta name='mobile-web-app-capable' content='yes' />
      <meta name='HandheldFriendly' content='True' />
      <meta name='MobileOptimized' content='320' />  
      <meta http-equiv='Content-Security-Policy' content='upgrade-insecure-requests' /> 
      <link href='css/bootstrap-4.5.2.min.css' rel='stylesheet' type='text/css' />
      <link href='css/offcanvas.css' rel='stylesheet' type='text/css' />
      <link href='css/main.css' rel='stylesheet' type='text/css' />
  </head>
  <noscript>You need to enable JavaScript to run this app.</noscript>
  <body>
    <div class='container-fluid'>
        <div class="row">
          <div class='col-sm-4 col-12'>
            <div class="card rounded-0">
              <div class="card-header p-1">ğŸ”ŠğŸ”‰ğŸ”ˆ <strong>Voice Settings</strong></div>
              <div id='speechSettingsCard' class="card-body p-2">
                <div class='row'>
                  <div class='col-4 col-sm-4'>
                      <input type="range" orient="vertical" min="0.5" max="2" value="1" step="0.1" class='slider' id="rate" />
                      <span class='badge badge-light rounded-0 p-0 ml-1'>á´¿áµƒáµ—áµ‰<span id="rateValue">1</span></span>
                  </div>
                  <div class='col-4 col-sm-4'>
                    <input type="range" orient="vertical" min="0" max="2" value="1" step="0.1" id="pitch" />
                    <span class='badge badge-light rounded-0 p-0 ml-1'>á´¾â±áµ—á¶œÊ°<span id="pitchValue">1</span></span>
                  </div>
                  <div class='col-4 col-sm-4'>
                    <input type="range" orient="vertical" min="0" max="1" value="1" step="0.1" id="volume" />
                    <span class='badge badge-light rounded-0 p-0 ml-1'>â±½áµ’Ë¡áµ˜áµáµ‰<span id="volumeValue">1</span></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class='col-sm-8 col-12'>
            <div class="card rounded-0">
              <div class="card-header p-1">â”ğŸ ‰â”“<strong>Upload File Content</strong>
                <button type="button" class="btn btn-default btn-sm border rounded-circle ml-2 pl-2 pr-2" data-toggle="popover" data-title="â­â½â½ Tesseract OCR Engine" data-dismissible="true" data-placement="right" data-content="<p class='mb-0'><p>â¶&nbsp;<small class='text-muted'><a href='https://github.com/naptha/tesseract.js' target='_blank'>TesseractJS</a> is an open-sourced OCR Engine which leverages on character recognition technology for text extraction.</small></p><p>â·&nbsp;<small class='text-muted'>By default, <strong>all pages</strong> in the PDF file shall be processed for text extraction (for this release).</small></p><p>â¸&nbsp;<small class='text-muted'>This software is opened to public for use licensed under âš– <a href='LICENSE-2.0.txt' target='_blank'>Apache-2.0 License</a>.</small></p></p>">ğŸ‘†*</button>
              </div> 
              <div id='uploadFileContentCard' class="card-body p-2">
                  <div class='row'> 
                    <div class='col-4 mr-0'>
                      <p class='w-100'><button id='uploadImgBtn' type='button' class='btn btn-sm btn-outline-primary rounded-0'><small>ğŸ“‚ Select Image</small><input id='uploadImg' type='file' accept='image/*' /></button></p>
                      <hr>
                      <div id='img-preview' class='small border text-center'></div>
                      <small><strong>ğŸ” Image Text Extraction</strong></small>
                      <div class="progress">
                        <div id="ocrImgProgress" class="progress-bar progress-bar-striped progress-bar-animated"></div>
                      </div>
                      <small id='ocrImgProgressStatus' class='small'></small>
                    </div>
                    <div class='col-5 mr-0'>
                      <p class='w-100'><button id='uploadPDFBtn' type='button' class='btn btn-sm btn-outline-primary rounded-0'><small>ğŸ“‚ Select PDF</small><input id='uploadPDF' type='file' accept='.pdf,.PDF' /></button> <span id='pageLoadingSignal'><span class="spinner-border spinner-border-sm"></span>&nbsp;<small class='text-muted'>Processing Page <span id='currentPageNo'>?</span><b>&nbsp;/&nbsp;<span id="totalPages">?</span>&nbsp;</b></small></span></p>
                      <hr>
                      <div id='page-preview' class='small border text-center'></div>
                      <small><strong>ğŸ” Page Text Extraction</strong></small>
                      <div class="progress">
                        <div id="ocrPageProgress" class="progress-bar progress-bar-striped progress-bar-animated"></div>
                      </div>
                      <small id='ocrPageProgressStatus' class='small'></small>
                    </div>
                    <div class='col-3 mr-0'>
                      <small id='processedPages' class='border small'></small>
                    </div>


                  </div>

              </div>
            </div>
          </div>
        </div>
        <hr>
        <div class='row'>
          <div class='col-12'>
            <div id='controllerCard' class="card rounded-0">
              <div class="card-header p-1">
                  <p class='mb-2 mt-2 mr-1'>ğŸ—£ğŸ’¬ <strong>Text-to-Speech Controller</strong><button type="button" class="btn btn-default btn-sm border rounded-circle ml-2 pl-2 pr-2" data-toggle="popover" data-title="ğŸ” User Guide ğŸ‘€" data-dismissible="true" data-placement="right" data-content="<p class='mb-0'><p>â¶&nbsp;â†âƒ&nbsp;<small class='text-muted'>Select <span class='badge badge-light rounded-circle border border-info text-info'><small>â¯ˆ</small></span> to listen to textâ€¤</small></p><p>â·&nbsp;â‡â€&nbsp;<small class='text-muted'>Manual edits & inputs are enabled in the text fieldâ€¤</small></p><p>â¸&nbsp;ââ‚&nbsp;<small class='text-muted'>Upload an image file/pdf doc for text extraction. Upon completion, output shall auto-append itself to existing input contentâ€¤</small></p><p><strong>â„¹ Speech Controls</strong><ul><li>â–¶â‡†â¸ <small class='text-info'>Toggle between playï¹ pause.</small></li><li>â–¶â†’â¸â‡†â¯ <small class='text-info'>Speech shall resume if paused before completion (assuming no stop command is triggered.).</small></li><li>â¹ <small class='text-danger'>Stops the speech regardless of completion status.</small></li></ul></p></p>">ğŸ‘†*</button><span class='float-right'><button id='speakBtn' class="btn btn-sm btn-outline-info rounded-circle pl-2 pr-2 pt-0 pb-1" type='button'><small>â–¶</small></button> <button id='stopBtn' class="btn btn-sm btn-outline-danger rounded-circle pl-2 pr-2 pt-0 pb-1" type='button'><small>â– </small></button> <button id='downloadTextContent' class="btn btn-sm btn-light border pl-2 pr-2 pt-0 pb-1 ml-4" type='button'><small>â”ğŸ ‹â”“ Download Text</small></button></span></p>
 

              </div>
              <div class="card-body p-0">
                <textarea id='inputText' class="form-control rounded-0 m-0">Let me read this for you.</textarea>
              </div>
            </div>
          </div>
        </div>
    </div>
    <script src='js/polyfill.js'></script>
    <script src='js/ie10-viewport-bug-workaround.js'></script>
    <script src='js/bootstrap-native-v4.js'></script>
    <script src='js/tesseract/tesseract.min.js'></script>
    <script src='js/pdf/pdf.min.js'></script>
    <script src='js/articulate.js'></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        var inputText=document.getElementById('inputText');

        const playSymbol='â–¶';
        const pauseSymbol='âšâš';

        document.getElementById('speakBtn').addEventListener('click', (evt) => {
          let isPaused=$().articulate('isPaused');
          let isSpeaking=$().articulate('isSpeaking');

          if(!isPaused && !isSpeaking) {
            let voiceText=document.createElement('div');
            voiceText.setAttribute('id','voiceText');
            voiceText.innerHTML=inputText.value;

            $(voiceText).articulate('speak');
            evt.currentTarget.innerHTML=pauseSymbol;
          } else if(!isPaused) {
            $().articulate('pause');
            evt.currentTarget.innerHTML=playSymbol;
          } else if(isPaused) {
            $().articulate('resume');
            evt.currentTarget.innerHTML=pauseSymbol;
          }
        }, false);
      
        window.addEventListener('utteranceHasEnded', (e) => {
          console.log('Detected');
          document.getElementById('speakBtn').innerHTML=playSymbol;
        }, false);

        document.getElementById('stopBtn').addEventListener('click', () => {
          $().articulate('stop');
        }, false);

        document.getElementById('pitch').addEventListener('change', (evt) => {
          let newPitchVal=parseFloat(evt.currentTarget.value);
          document.getElementById('pitchValue').textContent = newPitchVal;
          $().articulate('pitch', newPitchVal);
        }, false);

        document.getElementById('rate').addEventListener('change', (evt) => {
          let newRateVal=parseFloat(evt.currentTarget.value);
          document.getElementById('rateValue').textContent = newRateVal;
          $().articulate('rate', newRateVal);
        }, false);

        document.getElementById('volume').addEventListener('change', (evt) => {
          let newVolumeVal=parseFloat(evt.currentTarget.value);
          document.getElementById('volumeValue').textContent = newVolumeVal;
          $().articulate('volume', newVolumeVal);
        }, false);

        var popoverTargets = document.querySelectorAll('[data-content]');

        Array.from(popoverTargets).map(
          popTarget => new BSN.Popover(popTarget, {
            placement: 'right',
            animation: 'show',
            delay: 100,
            dismissible: true,
            trigger: 'click'
          })
        );

        function getCurrentDatetimeStamp() {
          const d = new Date();
          var datestamp=d.getFullYear()+''+(d.getMonth()+1)+''+d.getDate();
          var timestamp=d.getHours()+''+d.getMinutes()+''+d.getSeconds();

          var datetimeStr=datestamp+'_'+timestamp;
          return datetimeStr;
        }

        document.getElementById('downloadTextContent').addEventListener('click', (evt) => {
          if (!window.Blob) {
            alert('Your browser does not support HTML5 "Blob" function required to save a file.');
          } else {
            let textblob = new Blob([inputText.value], {
                type: 'application/plaintext'
            });
            let dwnlnk = document.createElement('a');
            dwnlnk.download = 'extractedTextContent_'+getCurrentDatetimeStamp()+'.txt';
            if (window.webkitURL != null) {
                dwnlnk.href = window.webkitURL.createObjectURL(textblob);
            }
            dwnlnk.click();
          }
        }, false);

        const tesseractWorkerPath='js/tesseract/worker.min.js';
        const tesseractLangPath='js/tesseract/lang-data/4.0.0_best';
        const tesseractCorePath='js/tesseract/tesseract-core.wasm.js';

        function readFileAsDataURL(file) {
          return new Promise((resolve,reject) => {
              let fileredr = new FileReader();
              fileredr.onload = () => resolve(fileredr.result);
              fileredr.onerror = () => reject(fileredr);
              fileredr.readAsDataURL(file);
          });
        }

        var pageLoadingSignal=document.getElementById('pageLoadingSignal');
        var pagePreview=document.getElementById('page-preview');
        var ocrPageProgress=document.getElementById('ocrPageProgress');
        var ocrPageProgressStatus=document.getElementById('ocrPageProgressStatus');
        
        var processedPages=document.getElementById('processedPages');
        var currentPageNo=document.getElementById('currentPageNo');
        var totalPages=document.getElementById('totalPages');

        var _PDF_DOC,
            _PAGE,
            _ZOOM_FACTOR = 1,
            currentPage = 1,
            noOfPages,
            _CANVAS=document.createElement('canvas');

        var uploadPDFBtn=document.getElementById('uploadPDFBtn');
        var uploadPDF=document.getElementById('uploadPDF');
        uploadPDFBtn.addEventListener('click', () => {
          uploadPDF.click();
        });

        uploadPDF.addEventListener('change', function(evt) {
            let file = evt.currentTarget.files[0];
            if(!file) return;
            readFileAsDataURL(file).then((b64str) => {
              showPDF(b64str);
            }, false);
        });

        async function showPage(pageNo) {
            currentPage = pageNo;
            currentPageNo.innerHTML = pageNo;
            try {
                _PAGE = await _PDF_DOC.getPage(pageNo);
            } catch(error) {
                alert(error.message);
            }
            return new Promise((resolve => resolve(_PAGE)));
        }

        var pdfWorker;
        async function initPdfTesseractWorker() {
          pdfWorker = Tesseract.createWorker({
              workerPath: tesseractWorkerPath,
              langPath:  tesseractLangPath,
              corePath: tesseractCorePath,
              logger: msg => {
                console.log(msg);
                if(msg.status=='recognizing text') {
                  ocrPageProgress['style']['width']=`${parseInt(parseFloat(msg.progress)*100)}%`;
                  ocrPageProgressStatus.innerHTML=`<p class='mb-1 mt-1'>â³ <strong>${parseInt(parseFloat(msg.progress)*100)}%</strong></p>`;
                }
              }
          });
          Tesseract.setLogging(true);

          await pdfWorker.load();
          await pdfWorker.loadLanguage('eng');
          await pdfWorker.initialize('eng');

          return new Promise((resolve) => resolve('worker initialised.'));
        }

        const loadImage = (url) => new Promise((resolve, reject) => {
          const img = new Image();
          img.addEventListener('load', () => resolve(img));
          img.addEventListener('error', (err) => reject(err));
          img.src = url;
        });

        async function extractPdfText(loadedImg) {
          const { data: { words } } = await pdfWorker.recognize(loadedImg);
          let combinedText='';
          for(let w of words) {
            let str=(w.text);
            let newStr = ( str.length>1 && str.charAt(str.length-1)=='-' ) ? str.substr(0,str.length-1) : (str+' ');
            combinedText+=newStr;
          }
          inputText.insertAdjacentText('beforeend', (' ' + combinedText));
          ocrPageProgress['style']['width']='100%';
          ocrPageProgress.classList.remove('progress-bar-animated');
          ocrPageProgressStatus.innerHTML=`<p class='mb-1 mt-1'>âŒ› <strong>Done.</strong></p>`;

          return new Promise((resolve) => resolve('extraction done.'));
        }

        async function showPDF(pdf_url) {
          pdfjsLib.GlobalWorkerOptions.workerSrc = 'js/pdf/pdf.worker.min.js';
          try {
              _PDF_DOC = await pdfjsLib.getDocument({ url: pdf_url });
          } catch(error) {
              console.log(error.message);
              throw new Error(error.message);
          }
          noOfPages = _PDF_DOC.numPages;
          totalPages.innerHTML = noOfPages;

          while(currentPage<=noOfPages) {
            await initPdfTesseractWorker();

            pageLoadingSignal['style']['visibility']='visible';
            currentPageNo.innerHTML=currentPage;

            _PAGE=await showPage(currentPage);
            let b64str=await scalePDFPage();
            pagePreview['style']['background-image']='url("'+b64str+'")';
            let loadedImg = await loadImage(b64str);
            await extractPdfText(loadedImg);
            processedPages.insertAdjacentHTML('beforeend', "<p class='mb-1 mt-1'>ğŸ—¹ Page "+currentPage+"â€” âŒ› <strong>Done.</strong></p>");

            await pdfWorker.terminate();

            currentPage++;
          } // end-while loop
          pageLoadingSignal['style']['visibility']='hidden';
        }
        
        const pixelRatio=window.devicePixelRatio*2;
        async function scalePDFPage() {
            let pdfOriginalWidth = _PAGE.getViewport(_ZOOM_FACTOR).width;
            let viewport = _PAGE.getViewport(_ZOOM_FACTOR);
            let viewpointHeight=viewport.height;

            _CANVAS.width=pdfOriginalWidth*pixelRatio;
            _CANVAS.height=viewpointHeight*pixelRatio;

            _CANVAS['style']['width'] = `${pdfOriginalWidth}px`;
            _CANVAS['style']['height'] = `${viewpointHeight}px`;

            _CANVAS.getContext('2d').scale(pixelRatio, pixelRatio);

            var renderContext = {
                canvasContext: _CANVAS.getContext('2d'),
                viewport: viewport
            };
            try {
                await _PAGE.render(renderContext);
            } catch(error) {
                alert(error.message);
            }
            return new Promise((resolve => resolve(_CANVAS.toDataURL())));
        }


        var imgPreview=document.getElementById('img-preview');
        var ocrImgProgress=document.getElementById('ocrImgProgress');
        var ocrImgProgressStatus=document.getElementById('ocrImgProgressStatus');

        var uploadImgBtn=document.getElementById('uploadImgBtn');
        var uploadImg=document.getElementById('uploadImg');
        uploadImgBtn.addEventListener('click', () => {
          uploadImg.click();
        });

        var imgWorker;
        async function initTesseractImgWorker() {
          imgWorker = Tesseract.createWorker({
              workerPath: tesseractWorkerPath,
              langPath:  tesseractLangPath,
              corePath: tesseractCorePath,
              logger: msg => {
                console.log(msg);
                if(msg.status=='recognizing text') {
                  ocrImgProgress['style']['width']=`${parseInt(parseFloat(msg.progress)*100)}%`;
                  ocrImgProgressStatus.innerHTML=`<p class='mb-1 mt-1'>â³ <strong>${parseInt(parseFloat(msg.progress)*100)}%</strong></p>`;
                }
              }
          });
          Tesseract.setLogging(true);

          await imgWorker.load();
          await imgWorker.loadLanguage('eng');
          await imgWorker.initialize('eng');

          return new Promise((resolve) => resolve('worker initialised.'));
        }

        uploadImg.addEventListener('change', (ev) => {
          let file = ev.currentTarget.files[0];
          if(!file) return;

          (async () => {
              await initTesseractImgWorker();

              let b64str=await readFileAsDataURL(file);
              imgPreview['style']['background-image']='url("'+b64str+'")';
              let loadedImg = await loadImage(b64str);

              const { data: { words } } = await imgWorker.recognize(loadedImg);
              let combinedText='';
              for(let w of words) {
                let str=(w.text);
                let newStr = ( str.length>1 && str.charAt(str.length-1)=='-' ) ? str.substr(0,str.length-1) : (str+' ');
                combinedText+=newStr;
              }
              inputText.insertAdjacentText('beforeend', (' ' + combinedText));

              await imgWorker.terminate();

              ocrImgProgress['style']['width']='100%';
              ocrImgProgress.classList.remove('progress-bar-animated');
              ocrImgProgressStatus.innerHTML=`<p class='mb-1 mt-1'>âŒ› <strong>Done.</strong></p>`;
          })();
        }, false);
      });
    </script>
  </body>
</html>